name: Cross-Platform Integration Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  SOLUTION_PATH: 'MultiDbSync/MultiDbSync.sln'
  CONSOLE_PROJECT: 'MultiDbSync/MultiDbSync.Console/MultiDbSync.Console.csproj'

jobs:
  # Build and test on all platforms in parallel
  test-matrix:
    name: Test on ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    
    strategy:
      fail-fast: false  # Continue testing other platforms even if one fails
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            arch: x64
            runtime: linux-x64
            display-name: 'Linux x64'
          
          # Linux ARM64 (GitHub-hosted runners available)
          - os: ubuntu-latest-arm
            arch: arm64
            runtime: linux-arm64
            display-name: 'Linux ARM64'
          
          # Windows x64
          - os: windows-latest
            arch: x64
            runtime: win-x64
            display-name: 'Windows x64'
          
          # Windows ARM64 (GitHub-hosted runners available)
          - os: windows-latest-arm
            arch: arm64
            runtime: win-arm64
            display-name: 'Windows ARM64'
          
          # macOS Intel (x64)
          - os: macos-13
            arch: x64
            runtime: osx-x64
            display-name: 'macOS Intel'
          
          # macOS Apple Silicon (ARM64)
          - os: macos-latest
            arch: arm64
            runtime: osx-arm64
            display-name: 'macOS Apple Silicon'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ“Š Display system information
        shell: bash
        run: |
          echo "=== System Information ==="
          echo "OS: ${{ matrix.display-name }}"
          echo "Runner: ${{ runner.os }}"
          echo "Architecture: ${{ matrix.arch }}"
          echo ""
          echo "=== .NET Information ==="
          dotnet --info
          echo ""
          echo "=== Runtime Information ==="
          dotnet --list-runtimes
      
      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}
      
      - name: ðŸ”¨ Build solution
        run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
      
      - name: ðŸ§ª Run unit tests
        run: dotnet test ${{ env.SOLUTION_PATH }} --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results-${{ matrix.runtime }}.trx"
      
      - name: ðŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.runtime }}
          path: '**/test-results-*.trx'
          retention-days: 7
      
      - name: ðŸš€ Run application demo (automated mode)
        shell: bash
        run: |
          echo "=== Running Application in Automated Mode ==="
          cd MultiDbSync/MultiDbSync.Console
          dotnet run --configuration Release -- --demo
      
      - name: âœ… Verify application ran successfully
        if: success()
        shell: bash
        run: |
          echo "âœ… Application demo completed successfully on ${{ matrix.display-name }}!"
      
      - name: âŒ Application failed
        if: failure()
        shell: bash
        run: |
          echo "âŒ Application demo failed on ${{ matrix.display-name }}"
          exit 1

  # Publish platform-specific executables for smoke testing
  publish-and-test:
    name: Publish & Test ${{ matrix.runtime }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            runtime: linux-x64
          - os: windows-latest
            runtime: win-x64
          - os: macos-13
            runtime: osx-x64
          - os: macos-latest
            runtime: osx-arm64
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ“¦ Publish self-contained executable
        run: |
          dotnet publish ${{ env.CONSOLE_PROJECT }} \
            --configuration Release \
            --runtime ${{ matrix.runtime }} \
            --self-contained true \
            --output ./publish/${{ matrix.runtime }} \
            /p:PublishSingleFile=true \
            /p:PublishTrimmed=false \
            /p:DebugType=none \
            /p:DebugSymbols=false
      
      - name: ðŸ§ª Test published executable (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          chmod +x ./publish/${{ matrix.runtime }}/MultiDbSync.Console
          ./publish/${{ matrix.runtime }}/MultiDbSync.Console --demo
      
      - name: ðŸ§ª Test published executable (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & ".\publish\${{ matrix.runtime }}\MultiDbSync.Console.exe" --demo
      
      - name: ðŸ“¤ Upload published executable
        uses: actions/upload-artifact@v4
        with:
          name: executable-${{ matrix.runtime }}
          path: publish/${{ matrix.runtime }}/*
          retention-days: 7

  # Summary job that depends on all test jobs
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-matrix, publish-and-test]
    if: always()
    
    steps:
      - name: ðŸ“Š Check test results
        run: |
          echo "=== Test Matrix Results ==="
          echo "Test Matrix: ${{ needs.test-matrix.result }}"
          echo "Publish and Test: ${{ needs.publish-and-test.result }}"
          
          if [[ "${{ needs.test-matrix.result }}" == "success" && "${{ needs.publish-and-test.result }}" == "success" ]]; then
            echo "âœ… All tests passed on all platforms!"
            exit 0
          else
            echo "âŒ Some tests failed. Check individual job results."
            exit 1
          fi
      
      - name: ðŸ“ Generate summary
        if: always()
        run: |
          echo "## ðŸ§ª Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Test Matrix | Publish & Test |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| All Platforms | ${{ needs.test-matrix.result }} | ${{ needs.publish-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-matrix.result }}" == "success" && "${{ needs.publish-and-test.result }}" == "success" ]]; then
            echo "### âœ… All platforms passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application successfully built, tested, and ran on:" >> $GITHUB_STEP_SUMMARY
            echo "- Linux x64" >> $GITHUB_STEP_SUMMARY
            echo "- Linux ARM64" >> $GITHUB_STEP_SUMMARY
            echo "- Windows x64" >> $GITHUB_STEP_SUMMARY
            echo "- Windows ARM64" >> $GITHUB_STEP_SUMMARY
            echo "- macOS Intel (x64)" >> $GITHUB_STEP_SUMMARY
            echo "- macOS Apple Silicon (ARM64)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some platforms failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check individual job results for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Performance baseline test (optional)
  performance-test:
    name: Performance Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: ðŸ“¦ Restore and build
        run: |
          dotnet restore ${{ env.SOLUTION_PATH }}
          dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
      
      - name: â±ï¸ Run performance test
        shell: bash
        run: |
          cd MultiDbSync/MultiDbSync.Console
          
          echo "=== Performance Test ==="
          echo "Measuring execution time..."
          
          START_TIME=$(date +%s%N)
          dotnet run --configuration Release -- --demo
          END_TIME=$(date +%s%N)
          
          DURATION_NS=$((END_TIME - START_TIME))
          DURATION_MS=$((DURATION_NS / 1000000))
          DURATION_S=$((DURATION_MS / 1000))
          
          echo "Execution time: ${DURATION_S}.${DURATION_MS:(-3)} seconds"
          echo "PERF_TIME_MS=$DURATION_MS" >> $GITHUB_ENV
      
      - name: ðŸ“Š Performance summary
        run: |
          echo "## â±ï¸ Performance Baseline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Execution time: **${PERF_TIME_MS}ms**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Platform: Ubuntu Latest (x64)" >> $GITHUB_STEP_SUMMARY
          echo "Configuration: Release" >> $GITHUB_STEP_SUMMARY
